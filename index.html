<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold‑to‑Gold Exchange Calculator</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:0;padding:15px;background:#f4f4f4;color:#333;display:flex;flex-direction:column;align-items:center}
        .container{background:#fff;padding:20px;border-radius:8px;box-shadow:0 0 15px rgba(0,0,0,.1);width:100%;max-width:700px;box-sizing:border-box}
        h1{color:#d4af37;text-align:center;margin-bottom:20px}
        .input-group{margin-bottom:18px}
        .input-group label{display:block;margin-bottom:6px;font-weight:600;color:#555}
        .input-group input{width:calc(100% - 22px);padding:10px;border:1px solid #ddd;border-radius:4px;font-size:16px;box-sizing:border-box}
        .input-group input:focus{border-color:#d4af37;outline:none}
        .input-hint{font-size:.9em;color:#777;margin-top:5px}
        button{background:#d4af37;color:#fff;padding:12px 18px;border:none;border-radius:4px;cursor:pointer;font-size:16px;flex-grow:1;transition:background .3s}
        button:hover{background:#c89f29}
        #addItemBtn{background:#3498db;margin-top:5px}
        #addItemBtn:hover{background:#2980b9}
        #downloadCsvBtn{background:#8e44ad;margin-top:15px}
        #downloadCsvBtn:hover{background:#7d3c98}
        .gold-item-row{display:flex;gap:10px;align-items:center;margin-bottom:10px;padding:10px;border:1px solid #eee;border-radius:4px}
        .gold-item-row .input-group{flex-grow:1;margin-bottom:0}
        .gold-item-row input{width:calc(100% - 10px)}
        .remove-item-btn{background:#e74c3c;color:#fff;border:none;border-radius:4px;padding:8px 12px;cursor:pointer;font-size:14px;height:fit-content}
        .remove-item-btn:hover{background:#c0392b}
        .output-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:25px}
        .panel{background:#f9f9f9;padding:15px;border-radius:6px;box-shadow:0 0 5px rgba(0,0,0,.05)}
        .panel h2{color:#d4af37;margin-top:0;font-size:20px;text-align:center}
        .panel .row{display:flex;justify-content:space-between;margin:6px 0}
        .panel .row span:first-child{color:#555}
        .panel .total{font-weight:700;border-top:1px solid #ddd;padding-top:8px;margin-top:8px}
        @media(max-width:600px){.container{padding:15px}.gold-item-row{flex-direction:column;align-items:stretch}.remove-item-btn{width:100%;margin-top:5px}.output-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="container">
        <h1>Gold‑to‑Gold Exchange</h1>

        <!-- market rates -->
        <div class="input-group">
            <label for="rate24K">Market Gold Rate (24 K per g)</label>
            <input type="number" id="rate24K" placeholder="Enter 24K rate (e.g., 7000)">
            <div class="input-hint">Or enter the 22 K rate below.</div>
        </div>
        <div class="input-group">
            <input type="number" id="rate22K" placeholder="Enter 22K rate (e.g., 6416.67)">
        </div>

        <!-- offered rate / depreciation -->
        <div class="input-group">
            <label for="offeredRate22K">Offered Rate for Old Gold (22 K per g)</label>
            <input type="number" id="offeredRate22K" placeholder="Enter offered 22K rate">
            <div class="input-hint">If filled, depreciation auto‑calculates.</div>
        </div>
        <div class="input-group">
            <label for="depreciation">Depreciation on Old Gold (%)</label>
            <input type="number" id="depreciation" value="3">
        </div>

        <!-- old gold items -->
        <h2 style="margin-bottom:10px;color:#555;font-size:18px">Old Gold Items</h2>
        <div id="goldItemsContainer"></div>
        <button id="addItemBtn" onclick="addGoldItem()">+ Add Gold Item</button>

        <!-- new gold inputs -->
        <h2 style="margin:25px 0 10px;color:#555;font-size:18px">New Gold Purchase</h2>
        <div class="input-group">
            <label for="newGrams">Grams of New Gold</label>
            <input type="number" id="newGrams" placeholder="e.g., 15">
        </div>
        <div class="input-group">
            <label for="makingPct">Making Charge (%)</label>
            <input type="number" id="makingPct" value="10">
        </div>

        <!-- action buttons -->
        <button onclick="calculateExchange()" style="margin-top:20px">Calculate Exchange</button>
        <button id="downloadCsvBtn" onclick="downloadCSV()" style="display:none;">Download CSV</button>

        <!-- results -->
        <div id="results" style="display:none;" class="output-grid">
            <div class="panel" id="oldPanel">
                <h2>Old Gold Sale</h2>
                <div class="row"><span>Total Grams</span><span id="oldGrams"></span></div>
                <div class="row"><span>Gross Value</span><span id="oldGross"></span></div>
                <div class="row"><span>Depreciation (%)</span><span id="oldDep"></span></div>
                <div class="row total"><span>Net Value</span><span id="oldNet"></span></div>
            </div>
            <div class="panel" id="newPanel">
                <h2>New Gold Cost</h2>
                <div class="row"><span>Gold Value</span><span id="newGoldVal"></span></div>
                <div class="row"><span>Making Charge</span><span id="newMaking"></span></div>
                <div class="row"><span>GST (3%)</span><span id="newGst"></span></div>
                <div class="row total"><span>Total Cost</span><span id="newTotal"></span></div>
            </div>
            <div class="panel" style="grid-column:1 / -1;">
                <h2>Difference</h2>
                <div class="row total"><span id="diffLabel">Amount to Pay</span><span id="diffValue"></span></div>
            </div>
        </div>
    </div>

<script>
/* constants */
const K24=24;
const SUPPORTED=[18,19,20,21,22];

/* dom refs */
const r24El=document.getElementById('rate24K');
const r22El=document.getElementById('rate22K');
const offered22El=document.getElementById('offeredRate22K');
const depEl=document.getElementById('depreciation');
const itemsBox=document.getElementById('goldItemsContainer');
const newGramsEl=document.getElementById('newGrams');
const makingPctEl=document.getElementById('makingPct');
const results=document.getElementById('results');
const downloadBtn=document.getElementById('downloadCsvBtn');

/* output spans */
const oldGramsSp=document.getElementById('oldGrams');
const oldGrossSp=document.getElementById('oldGross');
const oldDepSp=document.getElementById('oldDep');
const oldNetSp=document.getElementById('oldNet');
const newGoldValSp=document.getElementById('newGoldVal');
const newMakingSp=document.getElementById('newMaking');
const newGstSp=document.getElementById('newGst');
const newTotalSp=document.getElementById('newTotal');
const diffValueSp=document.getElementById('diffValue');
const diffLabelSp=document.getElementById('diffLabel');

/* state */
var lastCsv='';
let idCounter=0;

/* helpers */
const rd=(v,dec=2)=>(+v).toFixed(dec);
function parsePurity(s){if(!s)return NaN; s=s.trim().toLowerCase(); let n=NaN; if(s.endsWith('k'))n=parseFloat(s); else if(s.endsWith('%'))n=parseFloat(s)/100*K24; else{const p=parseFloat(s); if(!isNaN(p)){if(p>0&&p<=1)n=p*K24; else if(p>=0&&p<=K24)n=p;}} return (isNaN(n)||n<0||n>K24)?NaN:n;}
function mapStd(k){for(let i=SUPPORTED.length-1;i>=0;i--){if(k>=SUPPORTED[i])return SUPPORTED[i];}return 0;}
function sync22from24(){const v=parseFloat(r24El.value); if(!isNaN(v)&&v>0)r22El.value=rd(v*(22/K24));}
function sync24from22(){const v=parseFloat(r22El.value); if(!isNaN(v)&&v>0)r24El.value=rd(v*(K24/22));}

r24El.addEventListener('input',()=>{sync22from24();autoDep();});
r22El.addEventListener('input',()=>{sync24from22();autoDep();});
offered22El.addEventListener('input',autoDep);
function autoDep(){const off=parseFloat(offered22El.value);const m22=parseFloat(r22El.value);if(!isNaN(off)&&off>0&&!isNaN(m22)&&m22>0)depEl.value=rd((1-off/m22)*100,2);}/* update dep */

function addGoldItem(){idCounter++;const row=document.createElement('div');row.className='gold-item-row';row.id=`item-${idCounter}`;row.innerHTML=`<div class="input-group"><label for="g-${idCounter}">Grams</label><input type="number" id="g-${idCounter}" class="item-grams" placeholder="e.g., 5"></div><div class="input-group"><label for="p-${idCounter}">Purity</label><input type="text" id="p-${idCounter}" class="item-purity" placeholder="e.g., 21K or 91.6%"></div><button class="remove-item-btn" onclick="removeGoldItem('item-${idCounter}')">Remove</button>`;itemsBox.appendChild(row);}addGoldItem();
function removeGoldItem(id){const n=document.getElementById(id);if(n)itemsBox.removeChild(n);}/* remove */

function calculateExchange(){lastCsv='';results.style.display='none';downloadBtn.style.display='none';
    /* validate rates */
    const r24=parseFloat(r24El.value); if(isNaN(r24)||r24<=0){alert('Enter valid 24K rate');return;}
    const market22=r24*(22/K24);
    /* depreciation */
    let depPct=parseFloat(depEl.value)/100; const offered22=parseFloat(offered22El.value); if(!isNaN(offered22)&&offered22>0){depPct=1-offered22/market22;depEl.value=rd(depPct*100,2);} if(isNaN(depPct)||depPct<0||depPct>1){alert('Enter valid depreciation');return;}
    /* items */
    const rows=document.querySelectorAll('.gold-item-row'); if(rows.length===0){alert('Add at least one old gold item');return;}
    let oldG=0,oldGross=0; const csvItems=[];
    for(let i=0;i<rows.length;i++){
        const g=parseFloat(rows[i].querySelector('.item-grams').value);
        const pStr=rows[i].querySelector('.item-purity').value;
        if(isNaN(g)||g<=0){alert(`Invalid grams in item ${i+1}`);return;}
        if(!pStr.trim()){alert(`Enter purity for item ${i+1}`);return;}
        const p=parsePurity(pStr); if(isNaN(p)){alert(`Invalid purity "${pStr}" in item ${i+1}`);return;}
        const mapped=mapStd(p); if(mapped===0&&p>0){alert(`Item ${i+1} purity below 18K`);return;}
        const priceMapped=(r24/K24)*mapped; const val=priceMapped*g; oldG+=g; oldGross+=val;
        csvItems.push({i:i+1,g:rd(g),purity:rd(p),mapped,val:rd(val)});
    }
    const oldNet=oldGross*(1-depPct);
    /* new gold */
    const newG=parseFloat(newGramsEl.value); if(isNaN(newG)||newG<=0){alert('Enter grams of new gold');return;}
    const makingPct=parseFloat(makingPctEl.value); if(isNaN(makingPct)||makingPct<0){alert('Enter making charge %');return;}
    const newGoldVal=newG*market22;
    const makingVal=newGoldVal*(makingPct/100);
    const gstVal=(newGoldVal+makingVal)*0.03;
    const newTotal=newGoldVal+makingVal+gstVal;

    const diff=newTotal-oldNet; diffLabelSp.textContent=diff>=0?'Amount to Pay':'Cash Back';

    /* fill */
    oldGramsSp.textContent=rd(oldG);
    oldGrossSp.textContent=`₹${rd(oldGross)}`;
    oldDepSp.textContent=`${rd(depPct*100)} %`;
    oldNetSp.textContent=`₹${rd(oldNet)}`;

    newGoldValSp.textContent=`₹${rd(newGoldVal)}`;
    newMakingSp.textContent=`₹${rd(makingVal)}`;
    newGstSp.textContent=`₹${rd(gstVal)}`;
    newTotalSp.textContent=`₹${rd(newTotal)}`;
    diffValueSp.textContent=`₹${rd(Math.abs(diff))}`;

    results.style.display='grid'; downloadBtn.style.display='inline-block';

    buildCsv({date:new Date().toISOString().split('T')[0],market24:rd(r24),market22:rd(market22),offered22:!isNaN(offered22)&&offered22>0?rd(offered22):'N/A',dep:rd(depPct*100,2),oldG:rd(oldG),oldGross:rd(oldGross),oldNet:rd(oldNet),newG:rd(newG),makingPct:rd(makingPct,2),newGoldVal:rd(newGoldVal),makingVal:rd(makingVal),gstVal:rd(gstVal),newTotal:rd(newTotal),diff:rd(diff),items:csvItems});
}

function buildCsv(s){const csv=[];csv.push('Date,Market24K,Market22K,Offered22K,Depreciation(%),OldGrams,OldGross,OldNet,NewGrams,Making%( ),NewGoldValue,MakingCharge,GST,NewTotal,Diff');csv.push(`${s.date},${s.market24},${s.market22},${s.offered22},${s.dep},${s.oldG},${s.oldGross},${s.oldNet},${s.newG},${s.makingPct},${s.newGoldVal},${s.makingVal},${s.gstVal},${s.newTotal},${s.diff}`);csv.push('');csv.push('Item#,Grams,InputPurityK,MappedK,Value');s.items.forEach(it=>csv.push(`${it.i},${it.g},${it.purity},${it.mapped},${it.val}`));lastCsv=csv.join('\n');}

function downloadCSV(){if(!lastCsv){alert('Run a calculation first');return;}const blob=new Blob([lastCsv],{type:'text/csv;charset=utf-8;'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`gold_exchange_${new Date().toISOString().split('T')[0]}.csv`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);}/* end */
</script>
</body>
</html>
