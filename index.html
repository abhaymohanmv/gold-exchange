<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gold‑to‑Gold Exchange Calculator</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;margin:0;padding:15px;background:#f4f4f4;color:#333;display:flex;flex-direction:column;align-items:center}
        .container{background:#fff;padding:20px;border-radius:8px;box-shadow:0 0 15px rgba(0,0,0,.1);width:100%;max-width:750px;box-sizing:border-box}
        h1{color:#d4af37;text-align:center;margin-bottom:20px}
        .input-group{margin-bottom:18px}
        .input-group label{display:block;margin-bottom:6px;font-weight:600;color:#555}
        .input-group input{width:calc(100% - 22px);padding:10px;border:1px solid #ddd;border-radius:4px;font-size:16px;box-sizing:border-box}
        .input-group input:focus{border-color:#d4af37;outline:none}
        .input-hint{font-size:.9em;color:#777;margin-top:5px}
        button{background:#d4af37;color:#fff;padding:12px 18px;border:none;border-radius:4px;cursor:pointer;font-size:16px;flex-grow:1;transition:background .3s}
        button:hover{background:#c89f29}
        #addItemBtn{background:#3498db;margin-top:5px}
        #addItemBtn:hover{background:#2980b9}
        #downloadCsvBtn{background:#8e44ad;margin-top:15px}
        #downloadCsvBtn:hover{background:#7d3c98}
        .gold-item-row{display:flex;gap:10px;align-items:flex-end;margin-bottom:10px;padding:10px;border:1px solid #eee;border-radius:4px;flex-wrap:wrap}
        .gold-item-row .input-group{flex-grow:1;margin-bottom:0;min-width:120px}
        .gold-item-row input{width:calc(100% - 10px)}
        .remove-item-btn{background:#e74c3c;color:#fff;border:none;border-radius:4px;padding:8px 12px;cursor:pointer;font-size:14px;height:fit-content}
        .remove-item-btn:hover{background:#c0392b}
        .output-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:25px}
        .panel{background:#f9f9f9;padding:15px;border-radius:6px;box-shadow:0 0 5px rgba(0,0,0,.05)}
        .panel h2{color:#d4af37;margin-top:0;font-size:20px;text-align:center}
        .panel .row{display:flex;justify-content:space-between;margin:6px 0}
        .panel .row span:first-child{color:#555}
        .panel .total{font-weight:700;border-top:1px solid #ddd;padding-top:8px;margin-top:8px}
        @media(max-width:600px){.container{padding:15px}.gold-item-row{flex-direction:column;align-items:stretch}.remove-item-btn{width:100%;margin-top:5px}.output-grid{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <div class="container">
        <h1>Gold‑to‑Gold Exchange</h1>

        <!-- market rates -->
        <div class="input-group">
            <label for="rate24K">Market Gold Rate (24 K per g)</label>
            <input type="number" id="rate24K" placeholder="Enter 24K rate (e.g., 7000)">
            <div class="input-hint">Or enter the 22 K rate below.</div>
        </div>
        <div class="input-group">
            <input type="number" id="rate22K" placeholder="Enter 22K rate (e.g., 6416.67)">
        </div>

        <!-- old gold items -->
        <h2 style="margin-bottom:10px;color:#555;font-size:18px">Old Gold Items</h2>
        <div id="goldItemsContainer"></div>
        <button id="addItemBtn" onclick="addGoldItem()">+ Add Gold Item</button>

        <!-- new gold inputs -->
        <h2 style="margin:25px 0 10px;color:#555;font-size:18px">New Gold Purchase</h2>
        <div class="input-group">
            <label for="newGrams">Grams of New Gold</label>
            <input type="number" id="newGrams" placeholder="e.g., 15">
        </div>
        <div class="input-group">
            <label for="makingPct">Making Charge (%)</label>
            <input type="number" id="makingPct" value="10">
        </div>

        <!-- action buttons -->
        <button onclick="calculateExchange()" style="margin-top:20px">Calculate Exchange</button>
        <button id="downloadCsvBtn" onclick="downloadCSV()" style="display:none;">Download CSV</button>

        <!-- results -->
        <div id="results" style="display:none;" class="output-grid">
            <div class="panel" id="oldPanel">
                <h2>Old Gold Sale</h2>
                <div class="row"><span>Total Grams</span><span id="oldGrams"></span></div>
                <div class="row"><span>Gross Value</span><span id="oldGross"></span></div>
                <div class="row"><span>Avg Dep (%)</span><span id="oldDep"></span></div>
                <div class="row total"><span>Net Value</span><span id="oldNet"></span></div>
            </div>
            <div class="panel" id="newPanel">
                <h2>New Gold Cost</h2>
                <div class="row"><span>Gold Value</span><span id="newGoldVal"></span></div>
                <div class="row"><span>Making Charge</span><span id="newMaking"></span></div>
                <div class="row"><span>GST (3%)</span><span id="newGst"></span></div>
                <div class="row total"><span>Total Cost</span><span id="newTotal"></span></div>
            </div>
            <div class="panel" style="grid-column:1 / -1;">
                <h2>Difference</h2>
                <div class="row total"><span id="diffLabel">Amount to Pay</span><span id="diffValue"></span></div>
            </div>
        </div>
    </div>

<script>
/* constants */
const K24=24;
const SUPPORTED=[18,19,20,21,22];

/* dom refs */
const r24El=document.getElementById('rate24K');
const r22El=document.getElementById('rate22K');
const itemsBox=document.getElementById('goldItemsContainer');
const newGramsEl=document.getElementById('newGrams');
const makingPctEl=document.getElementById('makingPct');
const results=document.getElementById('results');
const downloadBtn=document.getElementById('downloadCsvBtn');

/* output spans */
const oldGramsSp=document.getElementById('oldGrams');
const oldGrossSp=document.getElementById('oldGross');
const oldDepSp=document.getElementById('oldDep');
const oldNetSp=document.getElementById('oldNet');
const newGoldValSp=document.getElementById('newGoldVal');
const newMakingSp=document.getElementById('newMaking');
const newGstSp=document.getElementById('newGst');
const newTotalSp=document.getElementById('newTotal');
const diffValueSp=document.getElementById('diffValue');
const diffLabelSp=document.getElementById('diffLabel');

/* state */
var lastCsv='';
let idCounter=0;

/* helpers */
const rd=(v,dec=2)=>(+v).toFixed(dec);
function parsePurity(s){if(!s)return NaN; s=s.trim().toLowerCase(); let n=NaN; if(s.endsWith('k'))n=parseFloat(s); else if(s.endsWith('%'))n=parseFloat(s)/100*K24; else{const p=parseFloat(s); if(!isNaN(p)){if(p>0&&p<=1)n=p*K24; else if(p>=0&&p<=K24)n=p;}} return (isNaN(n)||n<0||n>K24)?NaN:n;}
function mapStd(k){for(let i=SUPPORTED.length-1;i>=0;i--){if(k>=SUPPORTED[i])return SUPPORTED[i];}return 0;}
function sync22from24(){const v=parseFloat(r24El.value); if(!isNaN(v)&&v>0)r22El.value=rd(v*(22/K24));}
function sync24from22(){const v=parseFloat(r22El.value); if(!isNaN(v)&&v>0)r24El.value=rd(v*(K24/22));}

r24El.addEventListener('input',()=>{sync22from24();});
r22El.addEventListener('input',()=>{sync24from22();});

function updateDepOffered(row){
    const pStr=row.querySelector('.item-purity').value;
    const p=parsePurity(pStr);
    if(isNaN(p))return;
    const mapped=mapStd(p);
    if(mapped===0)return;
    const r24=parseFloat(r24El.value);
    if(isNaN(r24)||r24<=0)return;
    const priceMapped=(r24/K24)*mapped;

    const depInput=row.querySelector('.item-dep');
    const offeredInput=row.querySelector('.item-offered');

    const offered=parseFloat(offeredInput.value);
    const dep=parseFloat(depInput.value);

    if(!isNaN(offered)&&offered>0){
        const dPct=(1-offered/priceMapped)*100;
        if(dPct>=0){depInput.value=rd(dPct,2);} 
    }else if(!isNaN(dep)&&dep>=0){
        const off=priceMapped*(1-dep/100);
        offeredInput.value=rd(off,2);
    }
}

function addGoldItem(){
    idCounter++;
    const row=document.createElement('div');
    row.className='gold-item-row';
    row.id=`item-${idCounter}`;
    row.innerHTML=`
        <div class="input-group">
            <label for="g-${idCounter}">Grams</label>
            <input type="number" id="g-${idCounter}" class="item-grams" placeholder="e.g., 5">
        </div>
        <div class="input-group">
            <label for="p-${idCounter}">Purity</label>
            <input type="text" id="p-${idCounter}" class="item-purity" placeholder="e.g., 21K or 91.6%">
        </div>
        <div class="input-group">
            <label for="o-${idCounter}">Offered Rate</label>
            <input type="number" id="o-${idCounter}" class="item-offered" placeholder="per g (₹)">
            <div class="input-hint">Or fill depreciation</div>
        </div>
        <div class="input-group">
            <label for="d-${idCounter}">Depreciation (%)</label>
            <input type="number" id="d-${idCounter}" class="item-dep" placeholder="e.g., 3">
        </div>
        <button class="remove-item-btn" onclick="removeGoldItem('item-${idCounter}')">Remove</button>`;

    itemsBox.appendChild(row);

    // auto sync offered/dep
    row.querySelectorAll('input').forEach(inp=>{
        inp.addEventListener('input',()=>updateDepOffered(row));
    });
}
addGoldItem();

function removeGoldItem(id){
    const n=document.getElementById(id);
    if(n)itemsBox.removeChild(n);
}

function calculateExchange(){
    lastCsv='';
    results.style.display='none';
    downloadBtn.style.display='none';

    const r24=parseFloat(r24El.value);
    if(isNaN(r24)||r24<=0){alert('Enter valid 24K rate');return;}
    const market22=r24*(22/K24);

    const rows=document.querySelectorAll('.gold-item-row');
    if(rows.length===0){alert('Add at least one old gold item');return;}

    let oldG=0,oldGross=0,oldNet=0;
    const csvItems=[];

    for(let i=0;i<rows.length;i++){
        const g=parseFloat(rows[i].querySelector('.item-grams').value);
        const pStr=rows[i].querySelector('.item-purity').value;
        const offeredInp=rows[i].querySelector('.item-offered');
        const depInp=rows[i].querySelector('.item-dep');

        if(isNaN(g)||g<=0){alert(`Invalid grams in item ${i+1}`);return;}
        if(!pStr.trim()){alert(`Enter purity for item ${i+1}`);return;}
        const p=parsePurity(pStr);
        if(isNaN(p)){alert(`Invalid purity "${pStr}" in item ${i+1}`);return;}
        const mapped=mapStd(p);
        if(mapped===0&&p>0){alert(`Item ${i+1} purity below 18K`);return;}
        const priceMapped=(r24/K24)*mapped;

        let offeredRate=parseFloat(offeredInp.value);
        let depPct=parseFloat(depInp.value);

        if(!isNaN(offeredRate)&&offeredRate>0){
            depPct=(1-offeredRate/priceMapped)*100;
            if(depPct<0){alert(`Offered rate too high in item ${i+1}`);return;}
            depInp.value=rd(depPct,2);
        }else if(!isNaN(depPct)&&depPct>=0){
            offeredRate=priceMapped*(1-depPct/100);
            offeredInp.value=rd(offeredRate,2);
        }else{
            alert(`Enter offered rate or depreciation for item ${i+1}`);return;
        }

        const grossVal=priceMapped*g;
        const netVal=offeredRate*g;

        oldG+=g;
        oldGross+=grossVal;
        oldNet+=netVal;

        csvItems.push({i:i+1,g:rd(g),purity:rd(p),mapped,val:rd(grossVal),dep:rd(depPct,2),offered:rd(offeredRate,2),net:rd(netVal)});
    }

    const overallDepPct=(1-oldNet/oldGross)*100;

    /* new gold */
    const newG=parseFloat(newGramsEl.value);
    if(isNaN(newG)||newG<=0){alert('Enter grams of new gold');return;}
    const makingPct=parseFloat(makingPctEl.value);
    if(isNaN(makingPct)||makingPct<0){alert('Enter making charge %');return;}

    const newGoldVal=newG*market22;
    const makingVal=newGoldVal*(makingPct/100);
    const gstVal=(newGoldVal+makingVal)*0.03;
    const newTotal=newGoldVal+makingVal+gstVal;

    const diff=newTotal-oldNet;
    diffLabelSp.textContent=diff>=0?'Amount to Pay':'Cash Back';

    /* fill UI */
    oldGramsSp.textContent=rd(oldG);
    oldGrossSp.textContent=`₹${rd(oldGross)}`;
    oldDepSp.textContent=`${rd(overallDepPct,2)} %`;
    oldNetSp.textContent=`₹${rd(oldNet)}`;

    newGoldValSp.textContent=`₹${rd(newGoldVal)}`;
    newMakingSp.textContent=`₹${rd(makingVal)}`;
    newGstSp.textContent=`₹${rd(gstVal)}`;
    newTotalSp.textContent=`₹${rd(newTotal)}`;
    diffValueSp.textContent=`₹${rd(Math.abs(diff))}`;

    results.style.display='grid';
    downloadBtn.style.display='inline-block';

    buildCsv({date:new Date().toISOString().split('T')[0],market24:rd(r24),market22:rd(market22),oldG:rd(oldG),oldGross:rd(oldGross),oldNet:rd(oldNet),oldDep:rd(overallDepPct,2),newG:rd(newG),makingPct:rd(makingPct,2),newGoldVal:rd(newGoldVal),makingVal:rd(makingVal),gstVal:rd(gstVal),newTotal:rd(newTotal),diff:rd(diff),items:csvItems});
}

function buildCsv(s){
    const csv=[];
    csv.push('Date,Market24K,Market22K,OldGrams,OldGross,OldNet,AvgDep%,NewGrams,Making%,NewGoldValue,MakingCharge,GST,NewTotal,Diff');
    csv.push(`${s.date},${s.market24},${s.market22},${s.oldG},${s.oldGross},${s.oldNet},${s.oldDep},${s.newG},${s.makingPct},${s.newGoldVal},${s.makingVal},${s.gstVal},${s.newTotal},${s.diff}`);
    csv.push('');
    csv.push('Item#,Grams,InputPurityK,MappedK,GrossVal,Dep%,OfferedRate,NetVal');
    s.items.forEach(it=>csv.push(`${it.i},${it.g},${it.purity},${it.mapped},${it.val},${it.dep},${it.offered},${it.net}`));
    lastCsv=csv.join('\n');
}

function downloadCSV(){
    if(!lastCsv){alert('Run a calculation first');return;}
    const blob=new Blob([lastCsv],{type:'text/csv;charset=utf-8;'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;
    a.download=`gold_exchange_${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
}
</script>
</body>
</html>
